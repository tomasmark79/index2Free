<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <title>Digitalspace.name</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='16' ry='16' fill='%23111'/%3E%3Ctext x='50' y='60' font-size='40' text-anchor='middle' fill='%23fff' font-family='Arial,Helvetica,sans-serif'%3EDot%3C/text%3E%3C/svg%3E">
    <style>
      :root {
        --bg-color: #ffffff;
        --text-color: #5d879b;
        --console-bg: #0998ff30;
        --console-text: #5d879b;
        --console-border: rgba(0, 0, 0, 0.2);
        --console-shadow: rgba(0, 0, 0, 0.1);
        --logo-bg: #e8f4f8;
        --error-color: #cc4444;
      }
      
      @media (prefers-color-scheme: dark) {
        :root {
          --bg-color: #1a1a1a;
          --text-color: #b5d6e3;
          --console-bg: #232b3309;
          --console-text: #b5d6e3;
          --console-border: rgba(255, 255, 255, 0.15);
          --console-shadow: rgba(0, 0, 0, 0.5);
          --logo-bg: #2a4a5a;
          --error-color: #ff6666;
        }
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: var(--bg-color);
        color: var(--text-color);
      }
      body {
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: stretch;
        justify-content: stretch;
      }
      canvas {
        display: block;
        width: 100vw;
        height: 100vh;
        background: transparent;
      }
      
      #console {
        position: absolute;
        bottom: 10px;
        left: 10px;
        right: 10px;
        max-height: 300px;
        background: var(--console-bg);
        color: var(--console-text);
        font-family: 'Courier New', monospace;
        font-size: 10px;
        padding: 10px;
        border-radius: 5px;
        overflow-y: auto;
        z-index: 9999;
        pointer-events: auto;
        border: 1px solid var(--console-border);
        box-shadow: 0 0 10px var(--console-shadow);
      }
      #console .log-line {
        margin: 2px 0;
        white-space: pre-wrap;
        word-break: break-word;
        text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <!-- <div id="logo-container" style="position:absolute;top:0;left:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:10;opacity:0;">
      <img id="logo-img" alt="DotName Logo" style="max-width:30vw;max-height:30vh;transition:opacity 0.5s ease-in-out;" />
    </div> -->
    <canvas id="canvas" tabindex="-1"></canvas>
    <!-- <div id="console"></div> -->
    <script type="text/javascript">
      var canvas = document.getElementById('canvas');
      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      window.addEventListener('resize', resizeCanvas);
      resizeCanvas();

      // Function to check WebGL capabilities before Module initialization
      function checkWebGLCapabilities() {
        const testCanvas = document.createElement('canvas');
        
        // Detect browser type for specific optimizations
        const isChrome = /Chrome/.test(navigator.userAgent) && !/Chromium/.test(navigator.userAgent);
        const isChromium = /Chromium/.test(navigator.userAgent);
        
        console.log('ðŸŒ Browser detection:', {
          isChrome: isChrome,
          isChromium: isChromium,
          userAgent: navigator.userAgent
        });
        
        // WebGL2 context attributes optimized for hardware acceleration
        const webgl2Attrs = {
          alpha: false,
          depth: true,
          stencil: false,
          antialias: true,
          premultipliedAlpha: false,
          preserveDrawingBuffer: false,
          powerPreference: "high-performance",
          failIfMajorPerformanceCaveat: false,
          desynchronized: false
        };
        
        const gl = testCanvas.getContext('webgl2', webgl2Attrs) || 
                  testCanvas.getContext('webgl', webgl2Attrs) || 
                  testCanvas.getContext('experimental-webgl', webgl2Attrs);
        
        if (gl) {
          const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
          if (debugInfo) {
            const vendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL);
            const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
            console.log('ðŸ” GPU Vendor:', vendor);
            console.log('ðŸ” GPU Renderer:', renderer);
            
            // Detect software rendering
            if (renderer && (renderer.toLowerCase().includes('software') || 
                           renderer.toLowerCase().includes('llvmpipe') ||
                           renderer.toLowerCase().includes('mesa') ||
                           renderer.toLowerCase().includes('swiftshader'))) {
              console.warn('âš ï¸ Software rendering detected. Hardware acceleration may not be available.');
              console.info('ðŸ’¡ To enable hardware acceleration in Chrome:');
              console.info('   1. Go to chrome://settings/');
              console.info('   2. Advanced â†’ System');
              console.info('   3. Enable "Use hardware acceleration when available"');
              console.info('   4. Restart Chrome');
              
              // Linux-specific advice for Chrome RPM
              if (isChrome && navigator.platform.toLowerCase().includes('linux')) {
                console.info('ðŸ§ Linux Chrome RPM specific fixes:');
                console.info('   â€¢ Add user to video/render groups: sudo usermod -a -G video,render $USER');
                console.info('   â€¢ Launch with GPU flags: google-chrome --enable-features=VaapiVideoDecoder --use-gl=egl');
                console.info('   â€¢ Consider Chrome Flatpak or Chromium for better GPU support');
                console.info('   â€¢ Check /dev/dri/ permissions');
              }
            } else {
              console.log('âœ… Hardware acceleration detected and working!');
              
              // Browser-specific status messages
              if (isChrome) {
                console.log('ðŸŸ¢ WebGL context created successfully. Hardware acceleration status determined by browser.');
              } else if (isChromium) {
                console.log('ðŸŸ¢ WebGL context created successfully. Hardware acceleration status determined by browser.');
              }
            }
          }
        }
      }
      
      // Check capabilities before starting
      checkWebGLCapabilities();

      var Module = {
        canvas: canvas,
        // Set WebGL context attributes for better hardware acceleration
        webglContextAttributes: {
          alpha: false,
          depth: true,
          stencil: false,
          antialias: true,
          premultipliedAlpha: false,
          preserveDrawingBuffer: false,
          powerPreference: "high-performance",
          failIfMajorPerformanceCaveat: false
        },
        print: function(text) {
          // Capture stdout from C++ and display in console
          addToConsole(text, 'stdout');
        },
        printErr: function(text) {
          // Capture stderr from C++ and display in console
          addToConsole(text, 'stderr');
        },
        onRuntimeInitialized: function() {
          // Load SVG from Emscripten virtual filesystem
          try {
            const svgData = FS.readFile('share/index2/assets/DotNameLogoV2.svg', { encoding: 'utf8' });
            const dataUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgData);
            const logoImg = document.getElementById('logo-img');
            const logoContainer = document.getElementById('logo-container');
            if (logoImg && logoContainer) {
              // Show logo with smooth transition
              logoImg.src = dataUrl;
              logoContainer.style.opacity = '1';
            }
          } catch (error) {
            console.warn('Could not load SVG from virtual filesystem:', error);
          }
        }
      };

      // Function to add text to the console div
      function addToConsole(text, type) {
        // Also log to browser developer console
        if (type === 'stderr') {
          console.error(text);
        } else {
          console.log(text);
        }
        
        const consoleDiv = document.getElementById('console');
        if (consoleDiv && text.trim()) {
          const line = document.createElement('div');
          line.className = 'log-line';
          
            // Use theme-aware colors from CSS variables
            if (type === 'stderr') {
            line.style.color = 'var(--error-color)';
            } else {
            line.style.color = 'var(--console-text)';
            }
          line.textContent = text;
          consoleDiv.appendChild(line);
          
          // Auto-scroll to bottom
          consoleDiv.scrollTop = consoleDiv.scrollHeight;
          
          // Limit number of lines to prevent memory issues
          if (consoleDiv.children.length > 100) {
            consoleDiv.removeChild(consoleDiv.firstChild);
          }
        }
      }
    </script>
    {{{ SCRIPT }}}
  </body>
</html>